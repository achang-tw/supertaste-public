const SuperCoupon={coupons:[],loaded:!1,async init(){if(!SuperCoupon.loaded){if(document.body.classList.contains("home"))return;try{await this.addBaseElement(),await this.loadStyles(),await this.loadCoupons(),this.loadFont(),this.loaded=!0}catch(e){console.error("loaded coupons failed!",e)}}},async addBaseElement(){const locateClass=".supertaste-coupon-locate";var target=document.querySelector(locateClass);if(!target){const targets=[".post-entry h2",".article-content h2","article h2",".entry-content h2"];var visibleElementCount=0;for(let i=0;i<targets.length;i++){const elements=document.querySelectorAll(targets[i]);visibleElementCount=0;for(const el of elements)if(el.checkVisibility()&&2===++visibleElementCount){target=el;break}if(target)break}}target&&target.before(await this.baseElement())},async baseElement(){const base=document.createElement("div");return base.classList.add("supertaste-coupon","splide","loading"),base.innerHTML='\n\t\t<div class="splide__track">\n\t\t\t<div class="collapse-icon" onclick="SuperCoupon.collapse()">\n\t\t\t\t<svg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t<path d="M12.42 0.451988L13.48 1.51299L7.70298 7.29199C7.61041 7.38514 7.50034 7.45907 7.37909 7.50952C7.25784 7.55997 7.12781 7.58594 6.99648 7.58594C6.86515 7.58594 6.73512 7.55997 6.61387 7.50952C6.49262 7.45907 6.38255 7.38514 6.28998 7.29199L0.50998 1.51299L1.56998 0.452987L6.99498 5.87699L12.42 0.451988Z" fill="#8A8A8A"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\n\t\t\t<div class="coupon-list splide__list"></div>\n\t\t</div>',base},async loadStyles(){var link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href="https://achang-tw.github.io/supertaste-public/style.min.css",document.head.appendChild(link)},pickCoupons(coupons,pickedAmount=3){const pickedCoupons=[];for(;pickedCoupons.length<pickedAmount;){const totalWeight=coupons.reduce((acc,coupon)=>acc+Number(coupon.weight),0);let randomNum=Math.random()*totalWeight;for(let coupon of coupons)if(randomNum-=Number(coupon.weight),randomNum<0){pickedCoupons.push(coupon);break}}return pickedCoupons},async loadCoupons(){const coupons=JSON.parse(localStorage.getItem("superCoupons")||"{}");coupons&&coupons.coupons&&coupons.coupons.length>0&&coupons.time&&(new Date).getTime()<coupons.time?(this.coupons=this.validCoupons(coupons.coupons),this.drawHTML()):fetch("https://ads.achang.tw/super-coupon/index.php").then(res=>res.json()).then(data=>{const validCoupons=this.validCoupons(data);this.coupons=validCoupons,localStorage.setItem("superCoupons",JSON.stringify({coupons:validCoupons,time:(new Date).getTime()+3e5})),this.drawHTML()})},validCoupons(coupons){return coupons.filter(coupon=>{const now=new Date,start=this.stringToDate(coupon.start),end=this.stringToDate(coupon.end);return now>=start&&now<=end})},stringToDate(dateString){dateString=dateString.replace(/\//g,"-").replace(/\s+/g," ");const[datePart,timePart]=dateString.split(" "),[year,month,day]=datePart.split("-").map(Number),[hours,minutes,seconds]=timePart.split(":").map(Number);return new Date(year,month-1,day,hours,minutes,seconds)},async drawHTML(){const validCoupons=this.validCoupons(this.coupons);validCoupons.length>0&&(Array.from(document.querySelectorAll(".supertaste-coupon .coupon-list")).map(container=>{container.innerHTML=this.pickCoupons(validCoupons,1).map(coupon=>{switch(coupon.title_info&&(coupon.title_info=coupon.title_info.replace(/\n/g,"<br>")),coupon.type){case"HTML畫版":coupon=coupon.image?`<div class="coupon-item splide__slide">\n\t\t\t\t\t\t\t\t\t<div class="coupon-item-container">\n\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-wrap">\n\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-img-wrap">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-img" style="background-image:url(${coupon.image})"></div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-content">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-content-wrap">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-title">${coupon.title}</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-info">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<img class="location-icon" src="https://achang-tw.github.io/supertaste-public/location.svg" />\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<span>${coupon.title_info}</span>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="cta-title">${coupon.cta_title}</div>`+(coupon.info_link?`<div class="coupon-item-info-link"><a href="${coupon.info_link}" target="_blank">看店家報導</a></div>`:"")+`</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-cta">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="cta-wrap">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-logo">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<picture>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<source srcset="https://achang-tw.github.io/supertaste-public/coupon-icon-mo.jpg" media="(max-width: 768px)">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="https://achang-tw.github.io/supertaste-public/coupon-icon-pc.jpg" alt="">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</picture>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="cta-title">${coupon.cta_title}</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="cta-btn"><a href="${coupon.link}" target="_blank">${coupon.cta_btn}</a></div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-ext">\n\t\t\t\t\t\t\t\t\t\t\t\t<a href="https://supertaste.tvbs.com.tw/offers" target="_blank">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<svg width="10" height="9" viewBox="0 0 10 9" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<circle cx="5.00004" cy="4.49998" r="3.99998" stroke="#68A7FF" stroke-width="0.399998"/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<path d="M4.616 6.51842V3.55698H5.19782V6.51842H4.616ZM4.90691 3.07989C4.80994 3.07989 4.72655 3.04498 4.65673 2.97516C4.58691 2.90147 4.552 2.81613 4.552 2.71917C4.552 2.61832 4.58691 2.53492 4.65673 2.46898C4.72655 2.39917 4.80994 2.36426 4.90691 2.36426C5.00776 2.36426 5.09309 2.39917 5.16291 2.46898C5.23273 2.53492 5.26763 2.61832 5.26763 2.71917C5.26763 2.81613 5.23273 2.90147 5.16291 2.97516C5.09309 3.04498 5.00776 3.07989 4.90691 3.07989Z" fill="#68A7FF"/>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-bg">\n\t\t\t\t\t\t\t\t\t\t\t<picture>\n\t\t\t\t\t\t\t\t\t\t\t\t<img src="https://achang-tw.github.io/supertaste-public/bg-pc.svg" alt="">\n\t\t\t\t\t\t\t\t\t\t\t</picture>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>`:`<div class="coupon-item splide__slide">\n\t\t\t\t\t\t\t\t\t<div class="coupon-item-container">\n\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-wrap no-img">\n\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-content">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-content-wrap">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-title"><a href="${coupon.link}" target="_blank">${coupon.title}</a></div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div>${coupon.title_info}</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div><a href="${coupon.info_link}" target="_blank">查看店家資訊</a></div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="coupon-item-bg">\n\t\t\t\t\t\t\t\t\t\t\t<picture>\n\t\t\t\t\t\t\t\t\t\t\t\t<img src="https://achang-tw.github.io/supertaste-public/bg-pc.svg" alt="">\n\t\t\t\t\t\t\t\t\t\t\t</picture>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>`;break;case"全圖模式":coupon=`<div class="coupon-item splide__slide">\n\t\t\t\t\t\t\t\t<div class="coupon-item-wrap">\n\t\t\t\t\t\t\t\t\t<div><a href="${coupon.link}" target="_blank"><img src="${coupon.image}" alt="${coupon.title}"></a></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>`}return coupon}).join("")}),document.querySelector(".supertaste-coupon").classList.remove("loading"))},loadFont(){if(window.WebFont)WebFont.load({google:{families:["Noto Sans TC:400,500,700"]}});else{const webfont=document.createElement("script");webfont.src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js",document.body.appendChild(webfont),webfont.onload=async()=>{WebFont.load({google:{families:["Noto Sans TC:400,500,700"]}})}}},collapse(){const coupon=document.querySelector(".supertaste-coupon");coupon.classList.toggle("collapsed")}};window.onload=()=>{SuperCoupon.init()},document.addEventListener("scroll",()=>{SuperCoupon.init()},{once:!0}),document.addEventListener("pointermove",()=>{SuperCoupon.init()},{once:!0});